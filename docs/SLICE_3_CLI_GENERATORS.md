# Slice 3: CLI Generators

**Status**: Ready to code after PR #17 merges

## Overview

CLI tool for scaffolding infrastructure resources from templates.

## Commands

```bash
alchemy-kit generate resource <name>
alchemy-kit generate block <name>
alchemy-kit generate workflow <name>
alchemy-kit generate cron <name>
```

## Implementation Plan

### 1. Create Branch

```bash
git checkout main && git pull
git checkout -b feat/cli-generators
mkdir -p packages/@alch/cli/{src,bin,templates}
```

### 2. Package Structure

```
packages/@alch/cli/
‚îú‚îÄ package.json
‚îú‚îÄ bin/
‚îÇ  ‚îî‚îÄ alchemy-kit.js       ‚Äì CLI entry point
‚îú‚îÄ src/
‚îÇ  ‚îî‚îÄ index.ts             ‚Äì Generator logic
‚îî‚îÄ templates/
   ‚îú‚îÄ resource/
   ‚îÇ  ‚îî‚îÄ worker.ts
   ‚îú‚îÄ block/
   ‚îÇ  ‚îú‚îÄ chat/
   ‚îÇ  ‚îÇ  ‚îú‚îÄ do.ts
   ‚îÇ  ‚îÇ  ‚îî‚îÄ worker.ts
   ‚îÇ  ‚îî‚îÄ queue/
   ‚îÇ     ‚îî‚îÄ worker.ts
   ‚îú‚îÄ workflow/
   ‚îÇ  ‚îî‚îÄ workflow.ts
   ‚îî‚îÄ cron/
      ‚îî‚îÄ handler.ts
```

### 3. Files to Create

#### `packages/@alch/cli/package.json`

```json
{
  "name": "@alch/cli",
  "version": "0.1.0",
  "description": "CLI generators for Alchemy infrastructure",
  "type": "module",
  "bin": {
    "alchemy-kit": "./bin/alchemy-kit.js"
  },
  "main": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts"
  },
  "keywords": ["alchemy", "cli", "generator", "infrastructure"],
  "author": "",
  "license": "MIT"
}
```

#### `packages/@alch/cli/bin/alchemy-kit.js`

```javascript
#!/usr/bin/env bun
import "../src/index.ts";
```

#### `packages/@alch/cli/src/index.ts`

```typescript
#!/usr/bin/env bun
import { $ } from "bun";
import { parseArgs } from "node:util";
import { existsSync } from "node:fs";
import { join } from "node:path";

const { positionals } = parseArgs({ 
  allowPositionals: true,
  strict: false,
});

const [cmd, type, name] = positionals;

async function generate(type: string, name: string) {
  // Validate inputs
  if (!type || !name) {
    console.error("Usage: alchemy-kit generate <type> <name>");
    console.error("\nTypes: resource, block, workflow, cron");
    process.exit(1);
  }

  // Find template directory
  const templateDir = join(import.meta.dir, "../templates", type);
  
  if (!existsSync(templateDir)) {
    console.error(`‚ùå Template type "${type}" not found`);
    console.error("\nAvailable types: resource, block, workflow, cron");
    process.exit(1);
  }

  // Create destination directory
  const destDir = join(process.cwd(), "src", `${type}s`, name);
  
  if (existsSync(destDir)) {
    console.error(`‚ùå Directory already exists: ${destDir}`);
    process.exit(1);
  }

  // Copy template files
  await $`mkdir -p ${destDir}`;
  await $`cp -r ${templateDir}/* ${destDir}/`;
  
  // Replace __NAME__ placeholder in all files
  const files = await $`find ${destDir} -type f`.text();
  for (const file of files.trim().split("\n")) {
    if (file) {
      await $`sed -i '' 's/__NAME__/${name}/g' ${file}`;
    }
  }

  console.log(`‚úÖ Generated ${type} "${name}" in ${destDir}`);
  console.log(`\nNext steps:`);
  console.log(`  cd ${destDir}`);
  console.log(`  # Edit the generated files`);
  console.log(`  alchemy deploy --profile dev`);
}

// Main CLI logic
if (cmd === "generate" || cmd === "g") {
  await generate(type, name);
} else if (cmd === "help" || cmd === "--help" || cmd === "-h" || !cmd) {
  console.log(`
alchemy-kit - Infrastructure code generator

Usage:
  alchemy-kit generate <type> <name>
  alchemy-kit g <type> <name>          (shorthand)

Types:
  resource   - Generic Cloudflare Worker
  block      - Reusable building block (chat, queue, etc.)
  workflow   - Durable Workflow
  cron       - Scheduled task handler

Examples:
  alchemy-kit generate resource hello
  alchemy-kit g block chat-room
  alchemy-kit generate workflow onboarding
  alchemy-kit g cron nightly-cleanup
  `);
} else {
  console.error(`‚ùå Unknown command: ${cmd}`);
  console.error("Run 'alchemy-kit help' for usage");
  process.exit(1);
}
```

#### `packages/@alch/cli/templates/resource/worker.ts`

```typescript
/**
 * __NAME__ Worker
 * Generated by alchemy-kit
 */

export default {
  async fetch(request: Request, env: any): Promise<Response> {
    const url = new URL(request.url);
    
    return new Response(JSON.stringify({
      message: "Hello from __NAME__",
      path: url.pathname,
      timestamp: new Date().toISOString(),
    }), {
      headers: { "Content-Type": "application/json" },
    });
  },
};
```

#### `packages/@alch/cli/templates/block/chat/do.ts`

```typescript
/**
 * __NAME__ Chat Room Durable Object
 * Generated by alchemy-kit
 */

import { DurableObject } from "cloudflare:workers";

export class __NAME__Room extends DurableObject {
  private sessions: Set<WebSocket>;

  constructor(ctx: DurableObjectState, env: any) {
    super(ctx, env);
    this.sessions = new Set();
  }

  async fetch(request: Request): Promise<Response> {
    if (request.headers.get("Upgrade") === "websocket") {
      const pair = new WebSocketPair();
      const [client, server] = Object.values(pair);

      this.ctx.acceptWebSocket(server);
      this.sessions.add(server);

      return new Response(null, {
        status: 101,
        webSocket: client,
      });
    }

    return new Response("__NAME__ chat room ready", { status: 200 });
  }

  async webSocketMessage(ws: WebSocket, message: string | ArrayBuffer) {
    // Broadcast to all connected clients
    for (const session of this.sessions) {
      if (session !== ws && session.readyState === WebSocket.OPEN) {
        session.send(message);
      }
    }
  }

  async webSocketClose(ws: WebSocket) {
    this.sessions.delete(ws);
  }

  async webSocketError(ws: WebSocket, error: Error) {
    console.error("WebSocket error:", error);
    this.sessions.delete(ws);
  }
}
```

#### `packages/@alch/cli/templates/block/chat/worker.ts`

```typescript
/**
 * __NAME__ Chat Worker
 * Generated by alchemy-kit
 */

export { __NAME__Room } from "./do";

export default {
  async fetch(request: Request, env: any): Promise<Response> {
    const url = new URL(request.url);
    
    if (request.headers.get("Upgrade") === "websocket") {
      const id = env.ROOM.idFromName("main-room");
      const room = env.ROOM.get(id);
      return room.fetch(request);
    }
    
    return new Response("__NAME__ chat worker ready", { status: 200 });
  },
};
```

#### `packages/@alch/cli/templates/workflow/workflow.ts`

```typescript
/**
 * __NAME__ Workflow
 * Generated by alchemy-kit
 */

export default class __NAME__Workflow {
  async run(event: any, step: any): Promise<void> {
    // Step 1: Initialize
    await step.do("initialize", async () => {
      console.log("__NAME__ workflow started");
      return { status: "initialized" };
    });

    // Step 2: Process
    await step.do("process", async () => {
      console.log("Processing __NAME__");
      return { status: "processed" };
    });

    // Step 3: Complete
    await step.complete("complete", {
      status: "completed",
      timestamp: new Date().toISOString(),
    });
  }
}
```

#### `packages/@alch/cli/templates/cron/handler.ts`

```typescript
/**
 * __NAME__ CRON Handler
 * Generated by alchemy-kit
 */

export default {
  async scheduled(event: ScheduledEvent, env: any): Promise<void> {
    console.log("__NAME__ CRON triggered at", new Date().toISOString());
    
    // Your scheduled task logic here
    
    console.log("__NAME__ CRON completed");
  },
};
```

### 4. Testing

```bash
# Link CLI globally
cd packages/@alch/cli
bun link

# Test generation
cd ../../
alchemy-kit generate resource hello
alchemy-kit g block chat-room
alchemy-kit generate workflow onboarding
alchemy-kit g cron nightly

# Verify files created
ls -la src/resources/hello/
ls -la src/blocks/chat-room/
ls -la src/workflows/onboarding/
ls -la src/crons/nightly/
```

### 5. PR Creation

```bash
git add -A
git commit -m "feat: Add CLI generators (Slice 3)

New package: @alch/cli

Commands:
- alchemy-kit generate resource <name>
- alchemy-kit generate block <name>
- alchemy-kit generate workflow <name>
- alchemy-kit generate cron <name>

Scaffolds from templates with __NAME__ replacement.
Completes Phase 2 infrastructure kit!"

git push origin feat/cli-generators

gh pr create \
  --title "feat: CLI generators (Slice 3)" \
  --body "$(cat docs/SLICE_3_PR_BODY.md)" \
  --label "cli,enhancement" \
  --base main
```

## Success Criteria

- [ ] CLI installs globally with `bun link`
- [ ] `alchemy-kit generate` creates files in correct locations
- [ ] `__NAME__` placeholder is replaced correctly
- [ ] All template types work (resource, block, workflow, cron)
- [ ] Help text is clear and useful
- [ ] Error messages are helpful

## What's Next

After Slice 3 merges:
- Polish documentation
- Publish to npm as `@alch/*` packages
- Create `bun create @alch/kit` template
- Ship Phase 2! üöÄ
